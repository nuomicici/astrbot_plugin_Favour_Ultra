<div align="center">
<img style="width:70%" src="https://count.getloli.com/@astrbot_plugin_Favour_Ultra?name=astrbot_plugin_Favour_Ultra&theme=booru-lewd&padding=5&offset=0&align=top&scale=1&pixelated=1&darkmode=auto" alt=":name">
</div>
# 好感度/关系管理插件
## 1. 插件概述
该插件是基于 **AstrBot 框架**开发的好感度管理工具，支持多平台用户（QQ、Telegram、企微等）的好感度动态计算与持久化存储。核心功能包括：
- 按「全局模式」或「会话隔离模式」管理用户好感度
- 基于 LLM 对话内容自动更新好感度与用户关系
- 完善的数据备份与安全机制（清空前自动备份）
- 精细化的管理员权限控制与普通用户查询功能
- 支持好感度分级规则配置，适配不同交互场景


## 2. 功能特点
| 功能分类         | 具体说明                                                                 |
|------------------|--------------------------------------------------------------------------|
| 多模式管理       | 支持「全局模式」（所有会话共享好感度）和「会话隔离模式」（每个对话独立计算） |
| 好感度分级       | 可配置好感度等级规则（如极度厌恶、喜欢、挚爱等），影响 LLM 交互态度         |
| 数据安全         | 清空数据时可自动生成带时间戳的备份文件，避免误操作导致数据丢失             |
| 权限控制         | 核心操作（如清空、删除、设置数据）仅限管理员执行，普通用户仅可查询自身数据 |
| LLM 深度集成     | 自动向 LLM Prompt 注入好感度规则，解析 LLM 返回标签更新数据，无需人工干预 |
| 多平台适配       | 支持多平台用户 ID 格式（字母、数字、`_`、`-`、`@`、`:` 等特殊字符）       |
| 完善的日志记录   | 关键操作（数据读写、命令执行、异常）均输出日志，便于问题排查               |


## 3. 安装
- 直接在astrbot的插件市场搜索“糯米茨”找到目标插件，点击安装，等待完成即可

- 也可以克隆源码到插件文件夹：

```bash
# 克隆仓库到插件目录
cd /AstrBot/data/plugins
git clone https://github.com/nuomicici/astrbot_plugin_GroupMemberQuery

# 控制台重启AstrBot
```

## 4. 详细配置说明
插件配置项支持在 AstrBot 管理界面修改，所有配置均有默认值，关键配置如下表：

| 配置项                | 类型    | 默认值 | 描述                                                                 | 注意事项                                                             |
|-----------------------|---------|--------|----------------------------------------------------------------------|----------------------------------------------------------------------|
| `default_favour`      | int     | 0      | 普通用户初始好感度（范围：-100 ~ 100）                               | 新用户首次交互时的初始值，超出范围会自动截断                         |
| `admin_default_favour`| int     | 50     | 管理员/好感度特使的初始好感度（范围：-100 ~ 100）                    | 特使仅初始好感度较高，无额外权限                                     |
| `favour_rule_prompt`  | text    | 分级规则 | 好感度等级规则提示词，定义 LLM 在不同好感度下的交互态度               | 默认包含 7 个等级（极度厌恶 ~ 挚爱），可参考格式自定义               |
| `enable_clear_backup` | bool    | true   | 清空数据时是否自动生成备份文件                                       | 开启时备份文件路径与数据文件一致，需手动清理旧备份                   |
| `is_global_favour`    | bool    | false  | 是否启用全局好感度模式                                               | 开启后所有会话共享数据，切换模式后原有数据不互通（两套独立数据）     |
| `favour_envoys`       | list    | []     | 好感度特使用户 ID 列表                                               | 列表内用户初始好感度同管理员，一行一个 ID 回车确认                   |
| `favour_increase_min` | int     | 1      | 好感度上升最小幅度                                                   | 需 ≤ `favour_increase_max`，且为非负数                               |
| `favour_increase_max` | int     | 3      | 好感度上升最大幅度                                                   | 需 ≥ `favour_increase_min`，且为非负数                               |
| `favour_decrease_min` | int     | 1      | 好感度下降最小幅度（绝对值）                                         | 需 ≤ `favour_decrease_max`，且为非负数                               |
| `favour_decrease_max` | int     | 5      | 好感度下降最大幅度（绝对值）                                         | 需 ≥ `favour_decrease_min`，且为非负数                               |


## 5. 命令使用说明
插件支持多种交互命令，按权限分为「普通用户命令」和「管理员命令」，所有命令均支持在聊天窗口直接发送。

### 5.1 普通用户命令
| 命令格式             | 功能描述                                   | 示例                     |
|----------------------|--------------------------------------------|--------------------------|
| `查看我的好感度`     | 查询当前用户自身的好感度、关系及会话模式   | 发送「查看我的好感度」   |
| `查看好感度帮助`     | 查看插件帮助文档（包含配置、命令、注意事项）| 发送「查看好感度帮助」   |

### 5.2 管理员命令
| 命令格式                               | 功能描述                                   | 权限要求       | 示例                                 |
|----------------------------------------|--------------------------------------------|----------------|--------------------------------------|
| `清空所有好感度数据`                   | 触发清空数据确认提示（避免误操作）         | 仅管理员       | 发送「清空所有好感度数据」           |
| `删除好感度数据 <用户ID>`              | 删除指定用户的好感度数据（按当前会话模式） | 仅管理员       | 发送「删除好感度数据 123456789」     |
| `设置好感度数据 <用户ID> <数值>`       | 设置指定用户的好感度（数值范围：-100~100） | 仅管理员       | 发送「设置好感度数据 123456789 80」  |
| `查询好感度数据`                       | 查看所有用户的好感度、关系、会话信息       | 仅管理员       | 发送「查询好感度数据」               |


## 6. 数据存储说明
插件数据存储在 AstrBot 数据目录下，默认路径为 `./data/favour_manager/`，关键文件如下：

| 文件名格式                              | 作用描述                                                                 | 存储格式示例                                                                 |
|-----------------------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|
| `haogan.json`                           | 核心数据文件，存储用户好感度与关系（按会话/全局模式）                     | ```json [{"userid":"123456789","session_id":"qq_group_123","favour":80,"relationship":"朋友"}] ``` |
| `global_favour.json`                    | 全局好感度数据文件，用于「非全局模式」下新会话初始值导入                 | ```json {"123456789": 50, "987654321": 30} ```                               |
| `haogan_backup_YYYYMMDD_HHMMSS.json`    | 清空数据时的备份文件（仅 `enable_clear_backup=true` 时生成）              | 同 `haogan.json` 格式，文件名含时间戳（如 `haogan_backup_20240520_153045.json`） |

### 数据安全提示
- 备份文件不会自动清理，需定期手动删除旧文件，避免占用磁盘空间；
- 若误删数据，可将备份文件重命名为 `haogan.json` 恢复（需先停止插件）；
- 迁移插件时，直接复制 `favour_manager/` 目录即可保留所有数据。


## 7. 核心工作机制
### 7.1 LLM Prompt 注入
插件在 LLM 生成响应前，会自动向 `system_prompt` 头部注入好感度规则，确保 LLM 按规则生成交互内容。注入的 Prompt 包含以下核心模块：
- **最高标准要求**：强制 LLM 优先遵循好感度规则，不可忽略或修改；
- **管理员列表**：告知 LLM 哪些用户是管理员，避免拒绝合法操作；
- **好感度详情**：当前用户的好感度、关系，以及初始值规则；
- **基础变化规则**：好感度上升/降低/持平的标签格式与幅度限制；
- **关系判定规则**：用户申请建立关系时的响应格式（如 `[用户申请确认关系朋友:true]`）。

### 7.2 LLM 响应解析
LLM 生成响应后，插件会解析响应文本中的特定标签，更新用户数据：
1. **好感度标签解析**：匹配 `[\[［]\s*好感度.*?[\]］]` 格式标签，提取最后一个有效变化值（如 `[好感度 上升：2]` 对应 +2，`[好感度 降低：3]` 对应 -3）；
2. **关系标签解析**：匹配 `[\[［]\s*用户申请确认关系\s*(.*?)\s*[:：]\s*(true|false)\s*[\]］]` 格式标签，确认是否建立/解除关系；
3. **数据更新**：根据解析结果更新 `haogan.json`，并处理特殊逻辑（如好感度＜0 时自动解除关系）；
4. **文本清理**：删除响应中的标签文本，避免用户看到底层规则。


## 8. 注意事项
1. **好感度范围限制**：所有好感度数值强制限制在 `-100 ~ 100`，超出范围会被自动截断（如设置 150 会变为 100，设置 -120 会变为 -100）；
2. **用户 ID 格式要求**：用户 ID 需符合「字母、数字、`_`、`-`、`@`、`:`」字符集，长度 ≤ 64，否则操作（如设置、删除）会失败；
3. **模式切换影响**：切换 `is_global_favour` 模式后，原有数据不会互通（全局模式用一套数据，会话模式用另一套），建议启用后不再频繁切换；
4. **LLM 依赖限制**：插件高度依赖 LLM 对中文规则的理解能力，若 LLM 未按格式生成标签（如漏写 `[好感度]`），则无法更新数据；
5. **插件卸载数据**：卸载插件时，会自动保存当前数据（需确保 `haogan.json` 可读写），重新安装后可继续使用旧数据；
6. **日志排查**：若出现数据不更新、命令无响应等问题，可查看 AstrBot 日志（搜索 `favour_manager` 相关关键词）定位错误。


## 9. 常见问题（FAQ）
### Q1：好感度不更新怎么办？
A1：排查以下几点：
1. 查看 LLM 响应是否包含 `[好感度]` 标签（若没有，需检查 `favour_rule_prompt` 是否配置正确）；
2. 检查用户 ID 是否符合格式（长度 ≤64，无特殊字符）；
3. 查看日志是否有 `写入haogan.json失败` 错误，确认目录权限是否足够。

### Q2：如何恢复误删的数据？
A2：若 `enable_clear_backup=true`，找到最新的备份文件（如 `haogan_backup_20240520_153045.json`），重命名为 `haogan.json` 并替换原文件，重启插件即可。

### Q3：全局模式和会话模式有什么区别？
A3：
- 全局模式（`is_global_favour=true`）：所有会话共享好感度，用户在不同群/私聊中的好感度一致；
- 会话模式（`is_global_favour=false`）：每个会话（如 QQ 群、私聊）独立计算好感度，数据不互通。

### Q4：特使用户有什么特殊权限？
A4：特使用户仅初始好感度同管理员（`admin_default_favour`），无额外权限（如无法执行管理员命令），仅用于区分重要用户。


## 10. 版本信息
- **当前版本**：v1.0
- **更新日志**：
  1. 新增数据备份功能（`enable_clear_backup` 配置项）；
  2. 优化用户 ID 格式校验，适配多平台；
  3. 修复「读-改-写」数据竞争问题（加锁确保原子性）；
  4. 完善命令反馈信息（如设置成功后显示当前值）；
  5. 补充插件卸载时的数据保存逻辑。

如需更多帮助，可访问 [插件 GitHub 仓库](https://github.com/nuomicici/astrbot_plugin_Favour_Ultra/) 获取最新文档。

# 联系
**作者**: 糯米茨  
**联系方式**: 
- [GitHub Issues](https://github.com/nuomicici/astrbot_plugin_GroupMemberQuery/issues)  
- [QQ](https://qm.qq.com/q/wMGXYfKKoS)
