<div align="center">
<img style="width:70%" src="https://count.getloli.com/@astrbot_plugin_Favour_Ultra?name=astrbot_plugin_Favour_Ultra&theme=booru-lewd&padding=5&offset=0&align=top&scale=1&pixelated=1&darkmode=auto" alt=":name">

# 好感度/关系管理插件


[![查看更新日志（v2.6）](https://img.shields.io/badge/查看更新日志-blue?style=for-the-badge)](#10-版本信息) 
[![未来计划](https://img.shields.io/badge/未来计划-purple?style=for-the-badge)](#11-未来计划)
[![来许愿！](https://img.shields.io/badge/来许愿！-ff69b4?style=for-the-badge)](#联系)

</div>

## 1. 插件概述
该插件是基于 **AstrBot 框架**开发的好感度管理工具，支持多平台用户（QQ、Telegram、企微等）的好感度动态计算与持久化存储。核心功能包括：
- **高级自定义功能**（其他好感度插件没有！）
- 按「**全局模式**」或「**会话隔离模式**」管理用户好感度
- 基于 LLM 对话内容自动更新好感度与用户关系
- 新增 **“冷暴力”** 模式，当好感度过低时自动限制用户交互
- 完善的数据备份与安全机制（清空前自动备份）
- 精细化的管理员权限控制与普通用户查询功能
- 支持好感度分级规则配置，适配不同交互场景
- 完善的权限等级系统，支持群成员等级权限管理


## 2. 功能特点
| 功能分类         | 具体说明                                                                 |
|------------------|--------------------------------------------------------------------------|
| 多模式管理       | 支持「全局模式」（所有会话共享好感度）和「会话隔离模式」（每个对话独立计算） |
| 好感度分级       | 可配置好感度等级规则（如极度厌恶、喜欢、挚爱等），影响 LLM 交互态度         |
| **冷暴力模式**   | 好感度低于阈值时自动进入限时冷暴力状态，拦截LLM请求并发送自定义回复      |
| 数据安全         | 清空数据时可自动生成带时间戳的备份文件，避免误操作导致数据丢失             |
| 权限控制         | 新增细粒度权限等级：普通用户、高等级成员、群管理员、群主、Bot管理员       |
| LLM 深度集成     | 自动向 LLM Prompt 注入好感度规则，解析 LLM 返回标签更新数据，无需人工干预 |
| 多平台适配       | 支持多平台用户 ID 格式（字母、数字、`_`、`-`、`@`、`:` 等特殊字符）       |
| 完善的日志记录   | 关键操作（数据读写、命令执行、异常）均输出日志，便于问题排查               |
| 权限继承         | Bot管理员 ≥ 群主 ≥ 群管理员 ≥ 高等级成员 ≥ 普通用户                       |


## 3. 安装
- 直接在astrbot的插件市场搜索"糯米茨"找到目标插件，点击安装，等待完成即可

- 也可以克隆源码到插件文件夹：

```bash
# 克隆仓库到插件目录
cd /AstrBot/data/plugins
git clone https://github.com/nuomicici/astrbot_plugin_Favour_Ultra

# 控制台重启AstrBot
```

## 4. 详细配置说明
插件配置项支持在 AstrBot 管理界面修改，所有配置均有默认值，关键配置如下表：

| 配置项                           | 类型    | 默认值                          | 描述                                                                 | 注意事项                                                             |
|----------------------------------|---------|---------------------------------|----------------------------------------------------------------------|----------------------------------------------------------------------|
| `default_favour`                 | int     | 0                               | 普通用户初始好感度（范围：-100 ~ 100）                               | 新用户首次交互时的初始值，超出范围会自动截断                         |
| `admin_default_favour`           | int     | 50                              | 管理员/好感度特使的初始好感度（范围：-100 ~ 100）                    | 特使仅初始好感度较高，无额外权限                                     |
| `favour_rule_prompt`             | text    | 分级规则                        | 好感度等级规则提示词，定义 LLM 在不同好感度下的交互态度               | 默认包含 7 个等级（极度厌恶 ~ 挚爱），可参考格式自定义               |
| `enable_clear_backup`            | bool    | true                            | 清空数据时是否自动生成备份文件                                       | 开启时备份文件路径与数据文件一致，需手动清理旧备份                   |
| `is_global_favour`               | bool    | false                           | 是否启用全局好感度模式                                               | 开启后所有会话共享数据，切换模式后原有数据不互通（两套独立数据）     |
| `favour_envoys`                  | list    | []                              | 好感度特使用户 ID 列表                                               | 列表内用户初始好感度同管理员，一行一个 ID 回车确认                   |
| `favour_increase_min`            | int     | 1                               | 好感度上升最小幅度                                                   | 需 ≤ `favour_increase_max`，且为非负数                               |
| `favour_increase_max`            | int     | 3                               | 好感度上升最大幅度                                                   | 需 ≥ `favour_increase_min`，且为非负数                               |
| `favour_decrease_min`            | int     | 1                               | 好感度下降最小幅度（绝对值）                                         | 需 ≤ `favour_decrease_max`，且为非负数                               |
| `favour_decrease_max`            | int     | 5                               | 好感度下降最大幅度（绝对值）                                         | 需 ≥ `favour_decrease_min`，且为非负数                               |
| `level_threshold`                | int     | 50                              | 高等级成员等级阈值                                                   | 群成员等级达到此值可获得高等级成员权限                               |
| `cold_violence_threshold`        | int     | -50                             | 冷暴力触发阈值（范围：-100 ~ 100）                                    | 当好感度 ≤ 此值时，触发冷暴力模式                                    |
| `cold_violence_duration_minutes` | int     | 60                              | 冷暴力持续时长（分钟）                                               | 用户进入冷暴力模式后，在此时间内无法与LLM正常交互                    |
| `cold_violence_trigger_message`  | text    | `......（我不想理你了。）`     | 触发冷暴力时附加在LLM回复末尾的消息                                  | 若为空则不附加消息，但冷暴力模式依然生效                             |


## 5. 命令使用说明
插件支持多种交互命令，所有命令均通过 `命令 参数1 参数2...` 的格式触发，参数之间用空格隔开。

权限分为普通用户、群管理员、群主和 Bot 管理员，权限等级依次递增。

### 5.1 普通用户命令
适用于所有用户，无需特殊权限。

| 命令格式 | 功能描述 |
| :--- | :--- |
| `查看我的好感度` | 查询您在当前会话的好感度、关系等信息。<br>**别名**：`我的好感度`, `好感度查询`, `查看好感度`, `查询好感度` |
| `查看好感度帮助` | 显示插件的详细帮助文档，包含所有命令列表和注意事项。<br>**别名**：`好感度帮助`, `好感度插件帮助` |

### 5.2 管理员命令
需要指定的管理员权限才能使用。**权限等级**：`Bot管理员` > `群主` > `群管理员`。

| 命令格式 | 功能描述 | 权限要求 |
| :--- | :--- | :--- |
| `修改好感度 <用户ID> <数值>` | 精准设置指定用户的好感度值。数值范围：-100 到 100。<br>**作用范围**：依据当前会话模式（全局或当前会话）。 | **群管理员**及以上 |
| `删除好感度数据 <用户ID>` | 从数据库中删除指定用户的记录。<br>**作用范围**：依据当前会话模式。 | **群管理员**及以上 |
| `查询好感度数据` | 以图文形式列出**当前会话**内所有用户的好感度数据。<br>**别名**：`查看好感度数据`, `本群好感度查询`, `查看本群好感度`, `本群好感度` | **群管理员**及以上 |
| `查询全部好感度` | 以图文形式列出**所有会话**的好感度数据，按会话分组显示。<br>**别名**：`查看全部好感度`, `查询全局好感度`, `查看全局好感度`, `查询好感度全局` | **Bot管理员** |
| `清空当前好感度` | 清空**当前会话**的所有好感度数据。<br>**注意**：这是一个危险操作，需要输入 `清空当前好感度 确认` 来执行。 | **群主**及以上 |
| `清空全局好感度数据` | 清空**所有会话**的好感度数据，即清空整个 `haogan.json` 文件。<br>**注意**：这是一个高危操作，需要输入 `清空全局好感度数据 确认` 来执行。 | **Bot管理员** |

### 5.3 参数说明
*   `<用户ID>`：通常指用户的 QQ 号码。
*   `<数值>`：一个整数，用于设定好感度，范围必须在 -100 到 100 之间。

### 5.4 权限层级说明
*   `**Bot管理员**`：在机器人全局配置文件 `admins_id` 中指定的用户，拥有插件的最高权限，其权限**全局生效**。
*   `**群主**`：QQ 群的创建者，权限**仅在当前群生效**。
*   `**群管理员**`：由群主在 QQ 群中设置的管理员，权限**仅在当前群生效**。


## 6. 数据存储说明
插件数据存储在 AstrBot 数据目录下，默认路径为 `./data/hao_gan_du/`，关键文件如下：

| 文件名格式                              | 作用描述                                                                 | 存储格式示例                                                                 |
|-----------------------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|
| `haogan.json`                           | 核心数据文件，存储用户好感度与关系（按会话/全局模式）                     | ```json [{"userid":"123456789","session_id":"qq_group_123","favour":80,"relationship":"朋友"}] ``` |
| `global_favour.json`                    | 全局好感度数据文件，用于「非全局模式」下新会话初始值导入                 | ```json {"123456789": 50, "987654321": 30} ```                               |
| `haogan_backup_YYYYMMDD_HHMMSS.json`    | 清空数据时的备份文件（仅 `enable_clear_backup=true` 时生成）              | 同 `haogan.json` 格式，文件名含时间戳（如 `haogan_backup_20240520_153045.json`） |

### 数据安全提示
- 备份文件不会自动清理，需定期手动删除旧文件，避免占用磁盘空间；
- 若误删数据，可将备份文件重命名为 `haogan.json` 恢复（需先停止插件）；
- 迁移插件时，直接复制 `hao_gan_du/` 目录即可保留所有数据；
- 新版本完全兼容旧版本数据，升级时会自动迁移和校验数据格式。


## 7. 核心工作机制
### 7.1 LLM Prompt 注入
插件在 LLM 生成响应前，会自动向 `system_prompt` 头部注入好感度规则，确保 LLM 按规则生成交互内容。注入的 Prompt 包含以下核心模块：
- **最高标准要求**：强制 LLM 优先遵循好感度规则，不可忽略或修改；
- **权限等级信息**：告知 LLM 用户的具体权限等级，影响交互态度；
- **好感度详情**：当前用户的好感度、关系，以及初始值规则；
- **基础变化规则**：好感度上升/降低/持平的标签格式与幅度限制；
- **关系判定规则**：用户申请建立关系时的响应格式（如 `[用户申请确认关系朋友:true]`）。

### 7.2 LLM 响应解析
LLM 生成响应后，插件会解析响应文本中的特定标签，更新用户数据：
1. **好感度标签解析**：匹配 `[\[［]\s*好感度.*?[\]］]` 格式标签，提取最后一个有效变化值（如 `[好感度 上升：2]` 对应 +2，`[好感度 降低：3]` 对应 -3）；
2. **关系标签解析**：匹配 `[\[［]\s*用户申请确认关系\s*(.*?)\s*[:：]\s*(true|false)\s*[\]］]` 格式标签，确认是否建立/解除关系；
3. **数据更新**：根据解析结果更新 `haogan.json`，并处理特殊逻辑（如好感度＜0 时自动解除关系）；
4. **文本清理**：删除响应中的标签文本，避免用户看到底层规则。

### 7.3 冷暴力机制
当好感度变化导致用户当前好感度 **低于或等于** `cold_violence_threshold` 设定的阈值时，会触发冷暴力模式：
1. **触发**：用户被添加到一个临时列表中，并记录一个解锁时间（当前时间 + `cold_violence_duration_minutes`）。
2. **拦截**：在该用户下一次发送消息时，插件会**拦截**对LLM的请求，阻止生成正常回复。
3. **响应**：插件会直接返回一条自定义的“冷暴力”消息，例如：“[自动回复]不想理你,59分59秒后再找我”。
4. **恢复**：超过解锁时间后，用户的交互恢复正常，并从临时列表中移除。


## 8. 注意事项
1. **好感度范围限制**：所有好感度数值强制限制在 `-100 ~ 100`，超出范围会被自动截断（如设置 150 会变为 100，设置 -120 会变为 -100）；
2. **用户 ID 格式要求**：用户 ID 需符合「字母、数字、`_`、`-`、`@`、`:`、`.`」字符集，长度 ≤ 64，否则操作（如设置、删除）会失败；
3. **模式切换影响**：切换 `is_global_favour` 模式后，原有数据不会互通（全局模式用一套数据，会话模式用另一套），建议启用后不再频繁切换；
4. **权限等级说明**：
   - Bot管理员：配置中的admins_id成员，拥有所有权限
   - 群主：QQ群的群主角色，在所在群聊内有效
   - 群管理员：QQ群的管理员角色，在所在群聊内有效
   - 高等级成员：群等级达到阈值的成员（在配置界面配置）
   - 普通用户：默认权限，仅可查看自身好感度
5. **LLM 依赖限制**：插件高度依赖 LLM 对中文规则的理解能力，若 LLM 未按格式生成标签（如漏写 `[好感度]`），则无法更新数据；
6. **插件卸载数据**：卸载插件时，会自动保存当前数据（需确保 `haogan.json` 可读写），重新安装后可继续使用旧数据；
7. **日志排查**：若出现数据不更新、命令无响应等问题，可查看 AstrBot 日志（搜索 `hao_gan_du` 相关关键词）定位错误。


## 9. 常见问题（FAQ）
### Q1：好感度不更新怎么办？
A1：排查以下几点：
1. 查看 LLM 响应是否包含 `[好感度]` 标签（若没有，需检查 `favour_rule_prompt` 是否配置正确）；
2. 检查用户 ID 是否符合格式（长度 ≤64，无特殊字符）；
3. 查看日志是否有 `写入haogan.json失败` 错误，确认目录权限是否足够。

### Q2：如何恢复误删的数据？
A2：若 `enable_clear_backup=true`，找到最新的备份文件（如 `haogan_backup_20240520_153045.json`），重命名为 `haogan.json` 并替换原文件，重启插件即可。

### Q3：全局模式和会话模式有什么区别？
A3：
- 全局模式（`is_global_favour=true`）：所有会话共享好感度，用户在不同群/私聊中的好感度一致；
- 会话模式（`is_global_favour=false`）：每个会话（如 QQ 群、私聊）独立计算好感度，数据不互通。

### Q4：为什么触发冷暴力后，私聊也不回了？
A4：
- 因为冷暴力就是全局触发的。并且，是临时存储（这样才能好好计时），一旦重载就会恢复正常状态。
## 10. 版本信息
- **当前版本**：v2.6
- **更新日志**：
  - **v2.6 (2025年11月15日)**
    1. 在2.5的基础上，添加了更多的自定义配置项目，大致功能不变
    2. 添加了BOT管理员可以手动取消冷暴力状态的功能
    3. 还有什么来着，我忘了，想起来再写
  - **v2.5 (2025年11月15日)**
    1. **新增“冷暴力”模式**：当用户好感度低于预设阈值时，插件会自动进入限时“冷暴力”状态，拦截并回复特定消息，防止恶意骚扰。相关配置项已添加
    2. **优化代码结构**：重构了权限管理和文件读写逻辑，提升了稳定性和性能
    3. **完善用户昵称获取**：优化了在群聊和私聊中获取用户显示名称的逻辑，使其更加准确
    4. **更新文档**：同步更新了新功能、配置项和命令说明
  - **2025年11月3日**
    1. 更变标签清理方式,让LLM不会因为历史对话中不包含数据变化标签导致后续也不添加
    2. 保留好感度变化标签到历史记录中，可以从“对话数据”（或通过命令history）中查看变化详情 *（大优化！！！）*
  - **2025年11月2日**
    1. 扩大标签识别，防止因标签不完整而被错误输出
    2. 添加提醒，如果标签无效，可以在控制台查看error和warn输出
    3. 添加部分命令别名，查询类命令不完整或不规范也可以使用
    4. 对帮助文档进行分权限显示
  - **2025年10月5日**
    1. 新增权限等级系统，支持细粒度权限控制
    2. 优化数据管理机制，增强数据校验和错误处理
    3. 新增会话隔离/全局模式切换功能
    4. 完善命令系统，增加二次确认机制
    5. 优化用户体验，提供更详细的帮助文档
    6. 改进数据迁移机制，完全兼容旧版本数据

如需更多帮助，可访问 [插件 GitHub 仓库](https://github.com/nuomicici/astrbot_plugin_Favour_Ultra/) 获取最新文档。

## 11. 未来计划
- [x] 添加“冷暴力处理”，当好感度低于特定值的时候，会进入冷暴力模式，防止恶意用户捣乱
- [ ] 目前冷暴力是全局模式，暂时没有办法分对话冷暴力。后续稍微改改
- [ ] 添加模型判断，让好感度的判断不再局限与当前用于回复的LLM模型
- [ ] 关系的唯一性：目前关系全由LLM判断，也就有可能因为好感度都很高，然后出现了两个“最亲密的人”这样的情况。目前的想法是：准备每个群聊一个“超级好感”栏位，用于存放“特别的人”，单独占位。预计2.7上线。
- [ ] 启用群聊白名单功能
- [ ] 待定，欢迎补充~

# 联系
**作者**: 糯米茨  
**联系方式**: （许愿通道）
- [GitHub Issues](https://github.com/nuomicici/astrbot_plugin_Favour_Ultra/issues)  
- [QQ](https://qm.qq.com/q/wMGXYfKKoS)
## 求你们了
来~~鞭策~~支持一下叭！
